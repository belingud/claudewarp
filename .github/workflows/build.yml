name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: claudewarp
  PYTHON_VERSION: '3.11'

jobs:
  # test:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
    
  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: ${{ env.PYTHON_VERSION }}
    
  #   - name: Install uv
  #     uses: astral-sh/setup-uv@v4
  #     with:
  #       version: "latest"
    
  #   - name: Install dependencies
  #     run: |
  #       echo "ğŸ“¦ Installing dependencies with uv..."
  #       uv sync --all-groups --all-extras
  #       echo "âœ… Dependencies installed successfully"
    
  #   - name: Run tests
  #     run: |
  #       echo "ğŸ§ª Running tests..."
  #       uv run pytest tests/ -v --cov=claudewarp --cov-report=xml
  #       echo "âœ… Tests completed"
    
  #   - name: Upload coverage
  #     uses: codecov/codecov-action@v3
  #     if: success()
  #     with:
  #       file: ./coverage.xml

  build:
    # needs: test
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: macos
            arch: arm64
          - os: macos-13
            platform: macos
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64
          # å¯é€‰ï¼šæ·»åŠ Linuxæ”¯æŒ
          # - os: ubuntu-latest
          #   platform: linux
          #   arch: x64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ Setting up macOS dependencies..."
        # macOSç‰¹å®šä¾èµ–
        brew install create-dmg
        echo "âœ… macOS dependencies installed"
    
    - name: Install system dependencies (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo "ğŸªŸ Setting up Windows dependencies..."
        # Windowsç‰¹å®šä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰
        echo "Windows build setup complete"
    
    - name: Install Python dependencies
      run: |
        echo "ğŸ“¦ Installing Python dependencies with uv..."
        echo "UV version: $(uv --version)"
        uv sync --all-groups --all-extras
        echo "âœ… Dependencies installed successfully"
    
    - name: Build with Nuitka (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo "ğŸ”¨ Building Windows application with Nuitka..."
        echo "Platform: ${{ matrix.platform }}-${{ matrix.arch }}"
        echo "Python version: $(uv run python --version)"
        echo "Nuitka version: $(uv run python -m nuitka --version)"
        
        uv run python -m nuitka --standalone \
          --enable-plugin=pyside6 \
          --windows-icon-from-ico=claudewarp/gui/resources/icons/claudewarp.ico \
          --output-filename=claudewarp.exe \
          --verbose \
          --show-progress \
          main.py
        
        echo "ğŸ“ Renaming output directory..."
        if [ -d "main.dist" ]; then
          mv main.dist claudewarp.dist
          echo "âœ… Renamed main.dist to claudewarp.dist"
        else
          echo "âŒ main.dist not found!"
          ls -la
        fi
        
        echo "ğŸ“‹ Build output:"
        ls -la claudewarp.*
    
    - name: Build with Nuitka (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ Building macOS application with Nuitka..."
        echo "Platform: ${{ matrix.platform }}-${{ matrix.arch }}"
        echo "macOS version: $(sw_vers -productVersion)"
        echo "Architecture: $(uname -m)"
        echo "Python version: $(uv run python --version)"
        echo "Nuitka version: $(uv run python -m nuitka --version)"
        
        uv run python -m nuitka --standalone \
          --macos-create-app-bundle \
          --enable-plugin=pyside6 \
          --macos-app-icon=claudewarp/gui/resources/icons/claudewarp.ico \
          --macos-app-name=ClaudeWarp \
          --output-filename=claudewarp \
          --verbose \
          --show-progress \
          main.py
        
        echo "ğŸ“ Renaming output app bundle..."
        if [ -d "main.app" ]; then
          mv main.app ClaudeWarp.app
          echo "âœ… Renamed main.app to ClaudeWarp.app"
        else
          echo "âŒ main.app not found!"
          ls -la
        fi
        
        echo "ğŸ“‹ Build output:"
        ls -la ClaudeWarp.app
        echo "ğŸ“‹ App bundle contents:"
        ls -la ClaudeWarp.app/Contents/
    
    - name: Create DMG (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ’¿ Creating DMG package for macOS..."
        if [ -d "ClaudeWarp.app" ]; then
          echo "âœ… ClaudeWarp.app found, creating DMG..."
          
          create-dmg \
            --volname "ClaudeWarp" \
            --volicon "ClaudeWarp.app/Contents/Resources/claudewarp.ico" \
            --window-pos 200 120 \
            --window-size 600 300 \
            --icon-size 100 \
            --icon "ClaudeWarp.app" 175 120 \
            --hide-extension "ClaudeWarp.app" \
            --app-drop-link 425 120 \
            "ClaudeWarp-${{ github.ref_name }}-macos-${{ matrix.arch }}.dmg" \
            "ClaudeWarp.app" || echo "âŒ DMG creation failed, will use ZIP instead"
          
          if [ -f "ClaudeWarp-${{ github.ref_name }}-macos-${{ matrix.arch }}.dmg" ]; then
            echo "âœ… DMG created successfully"
            ls -la *.dmg
          else
            echo "âš ï¸ DMG not found, creating ZIP fallback..."
            zip -r "ClaudeWarp-${{ github.ref_name }}-macos-${{ matrix.arch }}.zip" ClaudeWarp.app
          fi
        else
          echo "âŒ ClaudeWarp.app not found!"
          ls -la
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.platform }}-${{ matrix.arch }}
        path: |
          *.zip
          *.dmg
          *.tar.gz
          *.exe
          ClaudeWarp.app
          claudewarp.dist
        retention-days: 30
    
    - name: Debug - List all files
      run: |
        echo "ğŸ“‹ All files in current directory:"
        ls -la
        echo "ğŸ“ Checking for build artifacts:"
        find . -name "*.zip" -o -name "*.dmg" -o -name "*.exe" -o -name "ClaudeWarp.app" -o -name "claudewarp.dist" | head -20
    
    - name: Get version
      if: startsWith(github.ref, 'refs/tags/')
      id: version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: ClaudeWarp v${{ steps.version.outputs.VERSION }}
        body: |
          ## ClaudeWarp v${{ steps.version.outputs.VERSION }}
          
          ### ä¸‹è½½
          
          - **macOS Intel**: `claudewarp-${{ steps.version.outputs.VERSION }}-macos-x64.zip` æˆ– `.dmg`
          - **macOS Apple Silicon**: `claudewarp-${{ steps.version.outputs.VERSION }}-macos-arm64.zip` æˆ– `.dmg`
          - **Windows**: `claudewarp-${{ steps.version.outputs.VERSION }}-windows-x64.zip`
          
          ### å®‰è£…è¯´æ˜
          
          #### macOS
          1. ä¸‹è½½ `.dmg` æ–‡ä»¶æˆ– `.zip` å‹ç¼©åŒ…
          2. å¦‚æœæ˜¯ `.dmg`ï¼šåŒå‡»æ‰“å¼€ï¼Œæ‹–æ‹½ ClaudeWarp.app åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          3. å¦‚æœæ˜¯ `.zip`ï¼šè§£å‹åå°† ClaudeWarp.app ç§»åŠ¨åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
          
          #### Windows
          1. ä¸‹è½½ `.zip` å‹ç¼©åŒ…
          2. è§£å‹åˆ°ç›®æ ‡ç›®å½•
          3. è¿è¡Œ `claudewarp.exe`
          
          ### å˜æ›´æ—¥å¿—
          
          è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´å†…å®¹ã€‚
        files: |
          *.zip
          *.dmg
          *.tar.gz
          *.exe
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [build]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Build Status
      run: |
        echo "ğŸ“Š Build Summary:"
        # echo "Test result: ${{ needs.test.result }}"
        echo "Build result: ${{ needs.build.result }}"
        
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… All builds completed successfully!"
        else
          echo "âŒ Build failed!"
          # echo "Test status: ${{ needs.test.result }}"
          echo "Build status: ${{ needs.build.result }}"
          exit 1
        fi