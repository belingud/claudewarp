name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  PROJECT_NAME: claudewarp
  PYTHON_VERSION: '3.11'

jobs:
  # test:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
    
  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: ${{ env.PYTHON_VERSION }}
    
  #   - name: Install uv
  #     uses: astral-sh/setup-uv@v4
  #     with:
  #       version: "latest"
    
  #   - name: Install dependencies
  #     run: |
  #       echo "ğŸ“¦ Installing dependencies with uv..."
  #       uv sync --all-groups --all-extras
  #       echo "âœ… Dependencies installed successfully"
    
  #   - name: Run tests
  #     run: |
  #       echo "ğŸ§ª Running tests..."
  #       uv run pytest tests/ -v --cov=claudewarp --cov-report=xml
  #       echo "âœ… Tests completed"
    
  #   - name: Upload coverage
  #     uses: codecov/codecov-action@v3
  #     if: success()
  #     with:
  #       file: ./coverage.xml

  build:
    # needs: test
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: macos
            arch: arm64
          - os: macos-13
            platform: macos
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64
          # å¯é€‰ï¼šæ·»åŠ Linuxæ”¯æŒ
          # - os: ubuntu-latest
          #   platform: linux
          #   arch: x64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ Setting up macOS dependencies..."
        # macOSç‰¹å®šä¾èµ–
        brew install create-dmg
        echo "âœ… macOS dependencies installed"
    
    - name: Install system dependencies (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        Write-Output "ğŸªŸ Setting up Windows dependencies..."
        # Windowsç‰¹å®šä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰
        Write-Output "Windows build setup complete"
    
    - name: Install Python dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ“¦ Installing Python dependencies with uv..."
        echo "UV version: $(uv --version)"
        uv sync --all-groups --all-extras
        echo "âœ… Dependencies installed successfully"
    
    - name: Install Python dependencies (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        Write-Output "ğŸ“¦ Installing Python dependencies with uv..."
        Write-Output "UV version: $(uv --version)"
        uv sync --all-groups --all-extras
        Write-Output "âœ… Dependencies installed successfully"
    
    - name: Build with PyInstaller (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        Write-Output "ğŸ”¨ Building Windows application with PyInstaller..."
        Write-Output "Platform: ${{ matrix.platform }}-${{ matrix.arch }}"
        Write-Output "Python version: $(uv run python --version)"
        
        # Run the Windows build script
        .\scripts\build_pyinstaller.ps1
    
    - name: Build with PyInstaller (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ Building macOS application with PyInstaller..."
        echo "Platform: ${{ matrix.platform }}-${{ matrix.arch }}"
        echo "macOS version: $(sw_vers -productVersion)"
        echo "Architecture: $(uname -m)"
        echo "Python version: $(uv run python --version)"
        
        # Run the Unix build script
        bash scripts/build_pyinstaller.sh
    
    - name: Create DMG (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ’¿ Creating DMG package for macOS..."
        if [ -d "dist/ClaudeWarp.app" ]; then
          echo "âœ… ClaudeWarp.app found, creating DMG..."
          
          # Determine DMG name based on version
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=$(echo "$GITHUB_REF" | sed 's/refs\/tags\/v\?//')
            DMG_NAME="ClaudeWarp-$VERSION-macos-${{ matrix.arch }}.dmg"
          else
            DMG_NAME="ClaudeWarp-macos-${{ matrix.arch }}.dmg"
          fi
          
          # Create a temporary directory for DMG creation
          mkdir -p dmg-temp
          cp -R dist/ClaudeWarp.app dmg-temp/
          
          # Create DMG with create-dmg
          create-dmg \
            --volname "ClaudeWarp" \
            --window-pos 200 120 \
            --window-size 600 300 \
            --icon-size 100 \
            --icon "ClaudeWarp.app" 175 120 \
            --hide-extension "ClaudeWarp.app" \
            --app-drop-link 425 120 \
            --no-internet-enable \
            "$DMG_NAME" \
            "dmg-temp" || echo "âŒ DMG creation failed, will use ZIP instead"
          
          # Clean up temporary directory
          rm -rf dmg-temp
          
          if [ -f "$DMG_NAME" ]; then
            echo "âœ… DMG created successfully: $DMG_NAME"
            ls -la "$DMG_NAME"
          else
            echo "âš ï¸ DMG creation failed, ZIP package will be available"
          fi
        else
          echo "âŒ ClaudeWarp.app not found!"
          ls -la dist/
        fi
    
    - name: Create release packages (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ“¦ Creating release packages..."
        
        # macOS packages
        if [ -d "dist/ClaudeWarp.app" ]; then
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=$(echo "$GITHUB_REF" | sed 's/refs\/tags\/v\?//')
            ZIP_NAME="ClaudeWarp-$VERSION-macos-${{ matrix.arch }}.zip"
          else
            ZIP_NAME="ClaudeWarp-macos-${{ matrix.arch }}.zip"
          fi
          
          # Create ZIP
          cd dist && zip -r "../$ZIP_NAME" ClaudeWarp.app && cd ..
          echo "âœ… macOS ZIP package created: $ZIP_NAME"
          
          # List all created packages
          ls -la *.zip *.dmg 2>/dev/null || ls -la *.zip
        else
          echo "âŒ ClaudeWarp.app not found!"
        fi
    
    - name: Create release packages (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        Write-Output "ğŸ“¦ Creating Windows release packages..."
        
        # The PowerShell script already created a ZIP, but we need to rename it for versioning
        if (Test-Path "dist\claudewarp.exe") {
          if ($env:GITHUB_REF -like "refs/tags/*") {
            if ($env:GITHUB_REF -like "refs/tags/v*") {
              $version = $env:GITHUB_REF -replace "refs/tags/v", ""
            } else {
              $version = $env:GITHUB_REF -replace "refs/tags/", ""
            }
            $newZipName = "ClaudeWarp-$version-windows-${{ matrix.arch }}.zip"
          } else {
            $newZipName = "ClaudeWarp-windows-${{ matrix.arch }}.zip"
          }
          
          # Find the ZIP created by the build script
          $buildZip = Get-ChildItem -Name "ClaudeWarp-Windows-*.zip" | Select-Object -First 1
          if ($buildZip) {
            # Rename to standardized format
            Move-Item $buildZip $newZipName
            Write-Output "âœ… Windows ZIP package renamed to: $newZipName"
          } else {
            # Fallback: create new ZIP if build script didn't create one
            Compress-Archive -Path "dist\claudewarp.exe" -DestinationPath $newZipName
            Write-Output "âœ… Windows ZIP package created: $newZipName"
          }
          Get-ChildItem *.zip
        } else {
          Write-Output "âŒ claudewarp.exe not found!"
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.platform }}-${{ matrix.arch }}
        path: |
          *.zip
          *.dmg
          dist/
        retention-days: 30
    
    - name: Debug - List all files (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        Write-Output "ğŸ“‹ All files in current directory:"
        Get-ChildItem
        Write-Output "ğŸ“ Checking for build artifacts:"
        Get-ChildItem -Recurse -Include "*.zip","*.exe","dist" | Select-Object -First 20
    
    - name: Debug - List all files (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ“‹ All files in current directory:"
        ls -la
        echo "ğŸ“ Checking for build artifacts:"
        find . -name "*.zip" -o -name "*.dmg" -o -name "dist" | head -20
    
    - name: Get version (Unix)
      if: startsWith(github.ref, 'refs/tags/') && matrix.platform == 'macos'
      id: version-unix
      run: |
        # Extract version from tag (handles both v1.0.0 and 1.0.0 formats)
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION="${{ github.ref }}"
          VERSION="${VERSION#refs/tags/v}"
        else
          VERSION="${{ github.ref }}"
          VERSION="${VERSION#refs/tags/}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"
    
    - name: Get version (Windows)
      if: startsWith(github.ref, 'refs/tags/') && matrix.platform == 'windows'
      id: version-windows
      shell: pwsh
      run: |
        # Extract version from tag (handles both v1.0.0 and 1.0.0 formats)
        $ref = "${{ github.ref }}"
        if ($ref -like "refs/tags/v*") {
          $version = $ref -replace "refs/tags/v", ""
        } else {
          $version = $ref -replace "refs/tags/", ""
        }
        Write-Output "VERSION=$version" >> $env:GITHUB_OUTPUT
        Write-Output "Extracted version: $version"
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        name: ClaudeWarp v${{ steps.version-unix.outputs.VERSION || steps.version-windows.outputs.VERSION }}
        body: |
          ## ClaudeWarp v${{ steps.version-unix.outputs.VERSION || steps.version-windows.outputs.VERSION }}
          
          ### ä¸‹è½½
          
          - **macOS Intel**: `ClaudeWarp-${{ steps.version-unix.outputs.VERSION || steps.version-windows.outputs.VERSION }}-macos-x64.zip` æˆ– `.dmg`
          - **macOS Apple Silicon**: `ClaudeWarp-${{ steps.version-unix.outputs.VERSION || steps.version-windows.outputs.VERSION }}-macos-arm64.zip` æˆ– `.dmg`
          - **Windows**: `ClaudeWarp-${{ steps.version-unix.outputs.VERSION || steps.version-windows.outputs.VERSION }}-windows-x64.zip`
          
          ### å®‰è£…è¯´æ˜
          
          #### macOS
          1. ä¸‹è½½ `.dmg` æ–‡ä»¶æˆ– `.zip` å‹ç¼©åŒ…
          2. å¦‚æœæ˜¯ `.dmg`ï¼šåŒå‡»æ‰“å¼€ï¼Œæ‹–æ‹½ ClaudeWarp.app åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          3. å¦‚æœæ˜¯ `.zip`ï¼šè§£å‹åå°† ClaudeWarp.app ç§»åŠ¨åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
          
          #### Windows
          1. ä¸‹è½½ `.zip` å‹ç¼©åŒ…
          2. è§£å‹å¾—åˆ° `claudewarp.exe`
          3. è¿è¡Œ `claudewarp.exe`
          
          ### å˜æ›´æ—¥å¿—
          
          è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´å†…å®¹ã€‚
        files: |
          *.zip
          *.dmg
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        token: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [build]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Build Status
      run: |
        echo "ğŸ“Š Build Summary:"
        # echo "Test result: ${{ needs.test.result }}"
        echo "Build result: ${{ needs.build.result }}"
        
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… All builds completed successfully!"
        else
          echo "âŒ Build failed!"
          # echo "Test status: ${{ needs.test.result }}"
          echo "Build status: ${{ needs.build.result }}"
          exit 1
        fi